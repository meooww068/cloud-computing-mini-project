<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>D·ª± ƒëo√°n ƒëi·ªÉm cu·ªëi k·ª≥</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body { background: #f6f8fc; position: relative; margin: 0; }
    .bg-logo { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; opacity: .25; pointer-events: none; z-index: 1; }
    .bg-logo img { width: 70%; max-width: 1000px; }
    .content { position: relative; z-index: 2; }
    .full-logo { position: fixed; inset: 0; opacity: .5; z-index: 0; pointer-events: none; }
    .full-logo img { width: 100%; height: 100%; object-fit: cover; }
    .card { border-radius: 16px; background: rgba(255, 255, 255, 0.85); }
  </style>
</head>
<body>



<!-- N·ªôi dung ch√≠nh -->
<div class="container py-5 content">
  <div class="row justify-content-center">
    <div class="col-lg-9">
      <div class="card shadow p-4 mb-4">
        <h3 class="text-center text-primary mb-3">üéØ D·ª± ƒëo√°n ƒëi·ªÉm cu·ªëi k·ª≥</h3>
        <form method="POST">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">M√¥n h·ªçc (ch·ªçn)</label>
              <select class="form-select" name="mon_hoc" id="monHocSelect">
                {% for sub in subjects %}
                  <option value="{{ sub }}" {% if request.form.get('mon_hoc')==sub %}selected{% endif %}>{{ sub }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6" id="monMoiGroup" style="display: {{ 'block' if request.form.get('mon_hoc')=='Kh√°c' else 'none' }};">
              <label class="form-label">Nh·∫≠p m√¥n m·ªõi</label>
              <input class="form-control" type="text" name="mon_moi" value="{{ request.form.get('mon_moi','') }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">ƒêi·ªÉm ƒë·∫ßu gi·ªù (0-10)</label>
              <input class="form-control" type="number" name="diem_dau_gio" step="0.1" min="0" max="10" value="{{ request.form.get('diem_dau_gio','0.0') }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">ƒêi·ªÉm k·ªπ nƒÉng (0-10)</label>
              <input class="form-control" type="number" name="diem_ky_nang" step="0.1" min="0" max="10" value="{{ request.form.get('diem_ky_nang','0.0') }}">
            </div>
            <div class="col-md-4">
              <label class="form-label">S·ªë bu·ªïi ƒëi h·ªçc</label>
              <select class="form-select" name="so_buoi_di_hoc">
                {% for val in ["ƒë·ªß","v·∫Øng 1","v·∫Øng 2","v·∫Øng 3"] %}
                  <option value="{{ val }}" {% if request.form.get('so_buoi_di_hoc')==val %}selected{% endif %}>{{ val }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">M·ª©c ƒë·ªô t·∫≠p trung</label>
              <select class="form-select" name="muc_do_tap_trung">
                {% for val in ["0-20%","21-40%","41-60%","61-80%","81-100%"] %}
                  <option value="{{ val }}" {% if request.form.get('muc_do_tap_trung')==val %}selected{% endif %}>{{ val }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">M·ª©c ƒë·ªô ti·∫øp nh·∫≠n ki·∫øn th·ª©c</label>
              <select class="form-select" name="muc_do_tiep_nhan">
                {% for val in ["0-20%","21-40%","41-60%","61-80%","81-100%"] %}
                  <option value="{{ val }}" {% if request.form.get('muc_do_tiep_nhan')==val %}selected{% endif %}>{{ val }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">M·ª©c ƒë·ªô t·ª± h·ªçc</label>
              <select class="form-select" name="muc_do_tu_hoc">
                {% for val in ["<1h","<3h",">3h"] %}
                  <option value="{{ val }}" {% if request.form.get('muc_do_tu_hoc')==val %}selected{% endif %}>{{ val }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button class="btn btn-success">D·ª± ƒëo√°n</button>
          </div>
        </form>
      </div>

      {% if prediction is not none %}
      <div class="card shadow p-4 mb-4">
        <h4 class="mb-2">K·∫øt qu·∫£</h4>
        <p class="mb-1">
          ƒêi·ªÉm d·ª± ƒëo√°n cu·ªëi k·ª≥: <strong>{{ prediction }}</strong>
          <small>(Sai s·ªë ¬±{{ error_margin }})</small>
        </p>
        <canvas id="chartContrib" height="260"></canvas>
        <script>
          const vals = {{ chart_vals | tojson }};
          const labels = ["ƒêi·ªÉm ƒë·∫ßu gi·ªù","ƒêi·ªÉm k·ªπ nƒÉng","Bu·ªïi h·ªçc","T·∫≠p trung","Ti·∫øp nh·∫≠n","T·ª± h·ªçc"];
          const colors = vals.map(v => v>=7.5 ? "#2E86C1" : (v>=5 ? "#F1C40F" : "#E74C3C"));
          const drawValuesPlugin = {
            id: 'drawValues',
            afterDatasetsDraw(chart) {
              const {ctx} = chart;
              ctx.save();
              ctx.font = '12px system-ui';
              ctx.fillStyle = '#333';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'bottom';
              const dataset = chart.data.datasets[0];
              chart.getDatasetMeta(0).data.forEach((bar, i) => {
                ctx.fillText(dataset.data[i], bar.x, bar.y - 4);
              });
              ctx.restore();
            }
          };
          new Chart(document.getElementById("chartContrib"), {
            type: "bar",
            data: { labels, datasets: [{ data: vals, backgroundColor: colors }]},
            options: { plugins:{legend:{display:false}}, scales:{ y:{min:0,max:10} } },
            plugins: [drawValuesPlugin]
          });
        </script>
      </div>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal Th√¥ng b√°o Trung b√¨nh -->
<div class="modal fade" id="avgModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center">
      <div class="modal-header">
        <h5 class="modal-title">Th√¥ng b√°o</h5>
      </div>
      <div class="modal-body" id="avgModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="resetBtn">OK</button>
      </div>
    </div>
  </div>
</div>

<!-- Logo n·ªÅn full m√†n h√¨nh -->
<div class="full-logo"><img src="{{ url_for('static', filename='logo.png') }}" alt=""></div>

<script>
  const sel = document.getElementById('monHocSelect');
  const monMoiGroup = document.getElementById('monMoiGroup');

  // Hi·ªÉn th·ªã/·∫©n √¥ "M√¥n m·ªõi"
  function toggleMonMoi() { 
    monMoiGroup.style.display = (sel.value === 'Kh√°c') ? 'block' : 'none'; 
  }

  // Khi ch·ªçn m√¥n h·ªçc kh√°c
  if (sel) {
    sel.addEventListener('change', function() {
      toggleMonMoi();

      // X√≥a d·ªØ li·ªáu d·ª± ƒëo√°n tr∆∞·ªõc
      localStorage.removeItem('predictions');

      // Reset c√°c input v·ªÅ gi√° tr·ªã m·∫∑c ƒë·ªãnh
      document.querySelector('input[name="diem_dau_gio"]').value = 0;
      document.querySelector('input[name="diem_ky_nang"]').value = 0;
      document.querySelector('select[name="so_buoi_di_hoc"]').selectedIndex = 0;
      document.querySelector('select[name="muc_do_tap_trung"]').selectedIndex = 0;
      document.querySelector('select[name="muc_do_tiep_nhan"]').selectedIndex = 0;
      document.querySelector('select[name="muc_do_tu_hoc"]').selectedIndex = 0;
    });

    document.addEventListener('DOMContentLoaded', toggleMonMoi);
  }

  // Qu·∫£n l√Ω 9 l·∫ßn d·ª± ƒëo√°n + Modal
  document.addEventListener("DOMContentLoaded", function () {
    let preds = JSON.parse(localStorage.getItem('predictions') || '[]');

    // N·∫øu v·ª´a POST c√≥ prediction -> th√™m v√†o danh s√°ch
    {% if prediction is not none %}
      preds.push({
        score: {{ prediction }},
        error: {{ error_margin|default('0') }},
        time: Date.now()
      });
      if (preds.length > 9) preds = preds.slice(-9);
      localStorage.setItem('predictions', JSON.stringify(preds));
    {% endif %}

    // Khi ƒë·ªß 9 l·∫ßn -> t√≠nh trung b√¨nh v√† MAD
    if (preds.length === 9) {
      const scores = preds.map(p => Number(p.score));
      const avgScore = scores.reduce((a,b)=>a+b,0) / scores.length;
      const mad = scores.reduce((s, x)=> s + Math.abs(x - avgScore), 0) / scores.length;

      let header = '', colorClass = '';
      if (avgScore < 4) { header='‚ö†Ô∏è B·∫°n c·∫ßn ch√∫ t√¢m v√†o m√¥n h·ªçc h∆°n.'; colorClass='text-danger'; }
      else if (avgScore > 8.5) { header='‚úÖ B·∫°n l√†m t·ªët l·∫Øm!'; colorClass='text-success'; }
      else { header='üìä K·∫øt qu·∫£ trung b√¨nh'; colorClass='text-primary'; }

      document.getElementById("avgModalBody").innerHTML =
        `<p class="${colorClass}">${header}</p>
         <p>ƒêi·ªÉm trung b√¨nh (9 l·∫ßn): <strong>${avgScore.toFixed(2)}</strong></p>
         <p>Sai s·ªë so v·ªõi TB (MAD): <strong>¬±${mad.toFixed(2)}</strong></p>`;

      const modal = new bootstrap.Modal(document.getElementById('avgModal'));
      modal.show();

      // N√∫t OK -> x√≥a d·ªØ li·ªáu v√† reload trang
      document.getElementById("resetBtn").onclick = () => {
        localStorage.removeItem('predictions');
        window.location.href = '{{ url_for("index") }}';
      };
    }
  });
</script>

</body>
</html>
